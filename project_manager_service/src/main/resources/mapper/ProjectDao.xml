<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.project_manager_service.dao.ProjectDao" >

    <insert id="createProject" parameterType="com.model.ProjectVO">
        INSERT INTO project
        (client_email, client_name, lead_jira_account_id, jira_project_key, phone_number, project_description,start_date,technologies, project_name, admin_id, project_lead)
        VALUES
        (#{clientEmail}, #{clientName},#{leadJiraAccountId},#{jiraProjectKey}, #{phoneNumber}, #{projectDescription},#{startDate},#{technologies},#{projectName}, #{adminId}, #{projectLead})
    </insert>

    <resultMap id="allProjectsResult" type="Map">
        <collection property="project_lead" ofType="com.model.UserVO" select="getProjectLead" column="project_lead" />
    </resultMap>

    <select id="getAllProjects" resultMap="allProjectsResult">
        SELECT * FROM project P
        <where>
            <if test="userLevel == 'ROLE_NON_ADMIN_USER' ">
                P.project_id IN (SELECT U.project_id FROM user_project U WHERE U.user_id = #{userId})
            </if>
            <if test="userLevel == 'ROLE_PROJECT_MANAGER' ">
                AND P.project_lead = #{userId}
            </if>
            <if test="phase != null">
                AND P.phase = #{phase}
            </if>
        </where>
        ORDER BY P.created_at DESC
    </select>

    <select id="getProjectLead" resultType="com.model.UserVO">
        SELECT * FROM app_user WHERE user_id = #{project_lead}
    </select>

    <select id="getProjectByJiraId" parameterType="String" resultType="com.model.ProjectVO">
        SELECT * FROM project WHERE jira_id = #{jiraId}
    </select>

    <update id="updateProject" parameterType="com.model.ProjectVO">
        UPDATE project
        SET
        project_lead = #{projectLead},
        lead_jira_account_id = #{leadJiraAccountId},
        status = #{status},
        client_email = #{clientEmail},
        client_name = #{clientName},
        phone_number = #{phoneNumber},
        project_description = #{projectDescription},
        technologies = #{technologies},
        start_date = #{startDate},
        project_name = #{projectName}
        WHERE
        project_id = #{projectId}
    </update>

    <delete id="deleteProject" parameterType="String">
        DELETE FROM project WHERE jira_project_key = #{jiraProjectKey}
    </delete>


    <update id="markAsFavorite" parameterType="Long">
        UPDATE project SET is_favorite = true WHERE project_id = #{projectId}
    </update>

    <update id="updateProjectPhase" parameterType="com.model.ProjectVO">
        UPDATE project SET phase = #{phase} WHERE project_id = #{projectId}
    </update>




</mapper>